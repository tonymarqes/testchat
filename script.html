<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <style>
        .embeddedServiceHelpButton {
            visibility: hidden;
        }

        .dockableContainer {
            border-radius: 10px !important;
            box-shadow: 0 3px 13px 0 rgba(0, 0, 0, .6) !important;
            max-height: 530px !important;
            width: 315px !important;
            bottom: 32px !important;
            right: 32px !important
        }

        h2[embeddedService-chatHeader_chatHeader] {
            letter-spacing: 0 !important
        }

        .sidebarHeader {
            background-color: #eceff5 !important;
            color: #212b36 !important;
            font-size: 18px !important;
            font-family: "Inter", sans-serif;
            padding: 0px 5px 0px 30px !important;
            box-shadow: rgb(83, 83, 83) 0px 0px 8px -1px !important;
        }

        [embeddedService-chatHeader_chatHeader-host] {
            height: 62px !important
        }

        .embeddedServiceSidebarButton {
            background-color: #212b36 !important;
            color: #eceff5 !important
        }

        .slds-icon {
            fill: #212b36 !important;
            height: 20px !important;
        }

        .slds-dropdown {
            background-color: #212b36 !important;
            color: #eceff5 !important
        }

        .waitingCancelChat {
            color: #eceff5 !important;
        }

        span.bBody {
            color: #eceff5 !important;
        }

        .plaintextContent.chasitor {
            background: rgb(229, 242, 255) !important;
            color: #000 !important;
        }

        b {
            font-family: inherit !important;
        }
    </style>

</head>

<body>
</body>
<!--script type='text/javascript' src='https://service.force.com/embeddedservice/5.0/esw.min.js'></script>-->
<script type='text/javascript'>
    window.addEventListener('message', receiver, false);
	
	/*window.addEventListener('message', function(event) {
		console.log('Evento de mensagem recebido');
        // Validate the origin to prevent malicious messages
        if (event.origin === 'https://expected.origin.com') { // Replace with the expected origin
            console.log('Message received:', event.data);
            // Process the received message (event.data)
        } else {
            console.warn('Message from unexpected origin:', event.origin);
        }
    });*/
	
	console.log('Teste');
	
    function receiver(e) {

        console.log("chegou no receiver at", e.origin)
        if ((e.origin == 'https://www.cea.com.br') || (e.origin === 'https://atendimentohomolog.cea.com.br') || (e.origin === 'https://webchatbot-ia-frontend.dev.ceabr.io')
            || (e.origin === 'https://d38apqh8v0g3dv.cloudfront.net') || (e.origin === 'https://webchatbot-ia-frontend.cea.com.br') || (e.origin === 'https://chatbot-cea.dev.cea-ecommerce.com.br') || (e.origin === 'https://chatindex.vercel.app')) {
            payload = JSON.parse(e.data)
            if (payload.from === "ceapay") {
                load_sales_ceapay(payload.email, payload.name, payload.msg, payload.cpf, payload.recordTypeID, payload.buttonID)
            }
        }
    }

    function load_sales_ceapay(_email, _name, _msg, _cpf, _recordTypeID, _buttonID) {
        var initESW = function (gslbBaseURL) {
            let email = ''
            let nome_cliente = ''
            let transcricao_bot = ''
            let ceapay = true
            let recordTypeId = _recordTypeID
			
			var teste = parent.window.embedded_svc;
			console.log(teste);
			
			
            embedded_svc.settings.displayHelpButton = true; //Ou falso
            embedded_svc.settings.language = ''; //Por exemplo, insira "pt" ou "pt-BR"
            embedded_svc.settings.extraPrechatInfo = [{
                "entityName": "Contact",
                "showOnCreate": true,
                "entityFieldMaps": [{
                    "isExactMatch": false,
                    "fieldName": "FirstName",
                    "doCreate": false,
                    "doFind": false,
                    "label": "Nome"
                }, {
                    "isExactMatch": false,
                    "fieldName": "LastName",
                    "doCreate": false,
                    "doFind": false,
                    "label": "Sobrenome"
                }]
            },
            {
                "entityName": "Case",
                "showOnCreate": true,
                "saveToTranscript": "CaseId",
                "entityFieldMaps": [{
                    "isExactMatch": false,
                    "fieldName": "Status",
                    "doCreate": true,
                    "doFind": false,
                    "label": "Status"
                }, {
                    "isExactMatch": false,
                    "fieldName": "SuppliedEmail",
                    "doCreate": true,
                    "doFind": false,
                    "label": "Email da Web"
                }, {
                    "isExactMatch": false,
                    "fieldName": "Origin",
                    "doCreate": true,
                    "doFind": false,
                    "label": "Origem"
                }, {
                    "isExactMatch": false,
                    "fieldName": "RecordTypeId",
                    "doCreate": true,
                    "doFind": false,
                    "label": "Tipo de Registro"
                },
                {
                    "isExactMatch": false,
                    "fieldName": "CeaPay__c",
                    "doCreate": true,
                    "doFind": false,
                    "label": "C&A Pay"
                }
                ]
            }
            ];

            embedded_svc.settings.extraPrechatFormDetails = [{
                "label": "Status",
                "value": "Novo",
                "transcriptFields": [],
                "displayToAgent": true
            }, {
                "label": "Origem",
                "value": "Chat",
                "transcriptFields": [],
                "displayToAgent": true
            }, {
                "label": "Tipo de Registro",
                "value": recordTypeId,
                "transcriptFields": [],
                "displayToAgent": true
            }, {
                "label": "Nome",
                "value": nome_cliente,
                "transcriptFields": [],
                "displayToAgent": true
            },
            {
                "label": "Email",
                "value": email,
                "transcriptFields": ["Email__c"],
                "displayToAgent": true
            },
            {
                "label": "Histórico do Chatbot",
                "value": transcricao_bot,
                "transcriptFields": ["TranscricaoHistoricoBot__c"],
                "displayToAgent": true
            },
            {
                "label": "C&A Pay",
                "value": ceapay,
                "transcriptFields": ["CeaPay__c"],
                "displayToAgent": false
            },
            {
                "label": "Documento de identificação",
                "value": _cpf,
                "transcriptFields": ["DocumentoIdentificacao__c"],
                "displayToAgent": true
            }
            ]

            embedded_svc.settings.defaultMinimizedText = 'online';
            embedded_svc.settings.disabledMinimizedText = 'offline';
            embedded_svc.settings.enabledFeatures = ['LiveAgent'];
            embedded_svc.settings.entryFeature = 'LiveAgent';
            //embedded_svc.settings.avatarImgURL = "https://chatbot-cea.dev.cea-ecommerce.com.br/assets/logo_sales.png"
            embedded_svc.init(
                'https://ceamodasorg--hml.sandbox.my.salesforce.com',
                'https://ceamodasorg--hml.sandbox.my.site.com/baseconhecimento',
                gslbBaseURL,
                '00D050000004bJI',
                'CeaPayChat', {
                baseLiveAgentContentURL: 'https://c.la12s-core1.sfdc-xwy4ub.salesforceliveagent.com/content',
                deploymentId: '57205000000007g',
                // buttonId: '5734x000000M2N6',  # ceapay
                buttonId: '5730500000000HR',
                baseLiveAgentURL: 'https://d.la12s-core1.sfdc-xwy4ub.salesforceliveagent.com/chat',
                eswLiveAgentDevName: 'C_A_Pay_Chat',
                isOfflineSupportEnabled: false
            }
            );
            embedded_svc.addEventHandler("onSettingsCallCompleted", function (data) {
                embedded_svc.settings.extraPrechatFormDetails[3].value = _name
                embedded_svc.settings.extraPrechatFormDetails[5].value = _msg
                embedded_svc.settings.extraPrechatFormDetails[7].value = _cpf
                document.getElementsByClassName('uiButton')[0].click()
            });

            embedded_svc.addEventHandler("afterDestroy", function (data) {
                document.getElementsByClassName("embeddedServiceHelpButton")[0].style.display = "none"
                parent.postMessage("open-chatbot", "*")
            });
            embedded_svc.addEventHandler("onChatRequestSuccess", function (data) {
                document.getElementsByClassName("embeddedServiceHelpButton")[0].style.display = "block"
                parent.postMessage("close-chatbot", "*")
            });
            embedded_svc.addEventHandler("onQueueUpdate", function (data) {
                document.getElementsByClassName("embeddedServiceHelpButton")[0].style.display = "block"
                parent.postMessage("close-chatbot", "*")
            });
            var checkButtonInterval;
            embedded_svc.addEventHandler('afterMaximize', function (data) {
                if (!checkButtonInterval) {
                    console.log('Em andamento...');
                    checkButtonInterval = setInterval(function () {
                        const embServiceButton = document.getElementsByClassName('embeddedServiceSidebarButton');
                        for (i = 0; i < embServiceButton.length; i++) {
                            if (embServiceButton[i].innerHTML.indexOf("Iniciar um novo chat") !== -1 || embServiceButton[i].innerHTML.indexOf("Start a New Chat") !== -1) {
                                console.log('Botão encontrado');
                                embServiceButton[i].style.display = 'none';
                                clearInterval(checkButtonInterval);
                                checkButtonInterval = null;
                            }
                        }
                    }, 200);
                }
            });
        };

        if (!window.embedded_svc) {
			console.log('Embedded_svc is not loaded');
            var s = document.createElement('script');
            s.setAttribute('src', 'https://ceamodasorg--hml.sandbox.my.salesforce.com/embeddedservice/5.0/esw.min.js');
            s.onload = function () {
                initESW(null);
            };
            document.body.appendChild(s);
        } else {
			console.log('Embedded_svc is loaded');
            initESW('https://service.force.com');
        }

        if (!window._laq) {
            window._laq = [];
        }
        window._laq.push(function () {
            liveagent.showWhenOnline('5734x000000M2N6', document.getElementById('liveagent_button_online_5734x000000M2N6'));
            liveagent.showWhenOffline('5734x000000M2N6', document.getElementById('liveagent_button_offline_5734x000000M2N6'));
        });
    }
</script>

</html>
